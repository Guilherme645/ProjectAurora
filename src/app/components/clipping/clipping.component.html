<div class="w-full min-h-screen flex flex-col clipping-container">
  <!-- Warning Modal -->
  <app-modal
    [isVisible]="isWarningModalVisible"
    [title]="modalTitle"
    [message]="modalMessage"
    subMessage="Você perderá todas as edições feitas dentro desse trecho."
    confirmButtonText="Remover trecho"
    (confirm)="handleDeleteConfirm()"
    (cancel)="handleModalClose()"
    (close)="handleModalClose()"
  ></app-modal>
  <!-- Header -->
 <app-header-clipping
    *ngIf="headerVisivel"
    class="relative z-50 block" 
    (saveClicked)="openSaveModal()"
    [(tituloMencao)]="clippingData.titulo"
    [(descricaoClipping)]="clippingData.descricao"
    (sentimentoChange)="updateSentimento($event)"
  ></app-header-clipping>
  <!-- Save Modal -->
  <div
    *ngIf="isSaveModalVisible"
    class="fixed inset-0 z-50 flex items-center justify-center bg-red backdrop-blur-sm"
  >
    <app-save-clipping-modal
      (close)="closeSaveModal()"
      [clippingData]="clippingData"
    ></app-save-clipping-modal>
  </div>
  <!-- Main Content -->
<div class="main-content relative z-0">    <!-- Player Column -->
    <div class="player-column">
      <!-- Timeline Box with Video Player -->
  
<div class="timeline-box">

  <div class="relative w-full group rounded-2xl overflow-hidden shadow-lg border border-gray-900 bg-black">
    
    <video #playerVideo 
      class="video-player w-full h-auto block"
      (click)="togglePlay()" 
      (loadedmetadata)="onMetadadosCarregados($event)" 
      (timeupdate)="onTempoAtualizado($event)"
      (play)="onPlay()"       
      (pause)="onPause()"     
      [poster]="posterImage">
        <source src="assets/video.mp4" type="video/mp4" />
        Seu navegador não suporta o elemento de vídeo.
    </video>

    <div class="absolute bottom-4 left-4 z-20 pointer-events-none transition-opacity duration-300">
      <div class="flex items-center justify-center w-10 h-10 rounded-full bg-black/50 backdrop-blur-sm text-white shadow-sm border border-white/10">
        <svg *ngIf="isVideoPlaying" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 ml-0.5">
          <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" />
        </svg>
        <svg *ngIf="!isVideoPlaying" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
          <path fill-rule="evenodd" d="M6.75 5.25a.75.75 0 01.75-.75H9a.75.75 0 01.75.75v13.5a.75.75 0 01-.75.75H7.5a.75.75 0 01-.75-.75V5.25zm7.5 0A.75.75 0 0115 4.5h1.5a.75.75 0 01.75.75v13.5a.75.75 0 01-.75.75H15a.75.75 0 01-.75-.75V5.25z" clip-rule="evenodd" />
        </svg>
      </div>
    </div>

  </div>
  <div class="timeline-controls-container">
          
          <button
    (click)="extendTimelineLeft()"
    [disabled]="expansionSide === 'right'"
    class="timeline-button disabled:opacity-50 disabled:cursor-not-allowed"
  >
    +5min
  </button>
          <div class="timeline-wrapper">
            <div
              #containerTimeline
              class="timeline-container"
              [class.has-selection]="isEffectiveSelection"
              [ngClass]="getTimelineBorderClass()"
              (click)="onTimelineClick($event)"
              (mousemove)="onTimelineHover($event)"
              (mouseleave)="onTimelineLeave()"
            >
              <!-- Played Range -->
              <div
                class="played-range"
                [style.left.px]="posicaoInicioPx"
                [style.width.px]="
                  posicaoPlayerPx > posicaoInicioPx
                    ? posicaoPlayerPx - posicaoInicioPx
                    : 0
                "
              ></div>
              <!-- Timeline Containers -->
              <div
                *ngFor="let container of timelineContainers; let i = index"
                class="absolute top-0 h-full rounded-md transition-colors duration-200 cursor-pointer"
                [ngClass]="getSegmentClass(i)"
                [style.width.px]="segmentWidth"
                [style.left.px]="i * segmentWidth"
                (dblclick)="selectContainer(i, $event)"
              ></div>
              <!-- Selection Highlight -->
              <div
                *ngIf="isEffectiveSelection"
                class="selection-highlight"
                [style.left.px]="selectionStartPx"
                [style.width.px]="selectionEndPx - selectionStartPx"
              >
                <div
                  class="selection-played"
                  [style.width.px]="selectionPlayedWidthPx"
                ></div>
              </div>
              <!-- Selection Segments -->
              <ng-container *ngIf="isEffectiveSelection">
                <div
                  *ngFor="let segment of selectionSegments"
                  class="selection-range"
                  [style.left.px]="
                    calculatePositionFromTime(segment.startTimeMs)
                  "
                  [style.width.px]="
                    calculatePositionFromTime(segment.endTimeMs) -
                    calculatePositionFromTime(segment.startTimeMs)
                  "
                  [ngClass]="{
                    playing:
                      isVideoPlaying &&
                      (tempoInicialMs > 0 || tempoFinalMs < videoDurationMs)
                  }"
                ></div>
              </ng-container>
              <!-- Structural Markers -->
              <div
                *ngFor="let marcador of structuralMarkers"
                class="time-marker"
                [ngClass]="{
                  'time-marker--selected': isMarkerInSelectedSegment(marcador)
                }"
                [style.left]="marcador.left"
              >
                {{ marcador.label }}
              </div>
              <!-- Start Handle -->
              <div
                class="handle start-handle flex items-center justify-center"
                [style.left.px]="posicaoInicioPx"
                [ngClass]="computeHandleBgClass('inicio')"
                (mousedown)="iniciarArrasto('inicio', $event)"
              >
                <svg class="w-3 h-3" viewBox="0 0 6 20" aria-hidden="true">
                  <rect x="0" y="0" width="2" height="20" fill="white" />
                  <rect x="4" y="0" width="2" height="20" fill="white" />
                </svg>
                <div class="handle-tooltip">
                  {{ formatTimestamp(tempoInicialMs) }}
                </div>
              </div>
              <!-- End Handle -->
              <div
                class="handle end-handle flex items-center justify-center"
                [style.left.px]="posicaoFimPx"
                [ngClass]="computeHandleBgClass('fim')"
                (mousedown)="iniciarArrasto('fim', $event)"
              >
                <svg class="w-3 h-3" viewBox="0 0 6 20" aria-hidden="true">
                  <rect x="0" y="0" width="2" height="20" fill="white" />
                  <rect x="4" y="0" width="2" height="20" fill="white" />
                </svg>
                <div class="handle-tooltip">
                  {{ formatTimestamp(tempoFinalMs) }}
                </div>
              </div>
              <!-- Playhead -->
              <div class="playhead" [style.left.px]="posicaoPlayerPx">
                <div class="playhead-tooltip">
                  {{ formatTimestamp(tempoAtualMs) }}
                </div>
              </div>
              <!-- Hover Tooltip -->
              <div
                *ngIf="showSeekTooltip"
                class="timeline-hover-tooltip"
                [style.left.px]="seekTooltipX"
              >
                {{ seekTooltipTime }}
              </div>
            </div>
          </div>
     <button
    (click)="extendTimelineRight()"
    [disabled]="expansionSide === 'left'"
    class="timeline-button disabled:opacity-50 disabled:cursor-not-allowed"
  >
    +5min
  </button>
        </div>
      </div>
      <!-- Entities Placeholder -->
      <div class="entities-placeholder">
        <app-clipping-entities
          [useAlternativeJson]="true"
          (textoMarcadoChange)="updateMarkedText($event)"
          (textoMarcadoSegmentsChange)="updateMarkedTextSegments($event)"
          (close)="onCloseDrawer()"
          (openEntityOptions)="onOpenEntityOptions($event)"
        ></app-clipping-entities>
      </div>
    </div>
    <!-- Transcription Column -->
    <div class="transcription-column">
      <div class="transcription-sticky">
        <!-- Header: Non-Search Mode -->
        <div *ngIf="!buscaAtiva" class="transcription-header">
          <div class="flex flex-col">
            <h2 class="text-sm font-semibold text-gray-900">Transcrição</h2>
            <span class="text-xs font-medium text-gray-500"
              >Menção completa</span
            >
          </div>
          <button
            (click)="ativarBusca()"
            title="Buscar na transcrição"
            class="flex items-center justify-center w-9 h-9 rounded-lg hover:bg-gray-100 transition-colors"
          >
            <svg
              class="w-5 h-5 text-gray-600"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path d="M21 21l-6-6m2-5a7 7 0 1 1-14 0 7 7 0 0 1 14 0z" />
            </svg>
          </button>
        </div>
        <!-- Header: Search Mode -->
        <div *ngIf="buscaAtiva" class="search-panel">
          <div
            class="flex-grow flex items-center gap-2 h-[44px] pl-3 pr-2 bg-white border border-gray-200 rounded-md transition-all duration-200"
          >
            <svg
              class="w-4 h-4 text-gray-500 flex-shrink-0"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              ></path>
            </svg>
            <input
              type="text"
              class="w-full h-full p-0 text-sm bg-transparent border-0 outline-none text-gray-800 placeholder:text-gray-400 focus:ring-0"
              [(ngModel)]="termoBusca"
              (ngModelChange)="onBuscaChange()"
              (keydown.enter)="navigateToNextMatch()"
              (keydown.escape)="desativarBusca()"
              placeholder="Insira a palavra que deseja buscar"
              #searchInput
            />
            <!-- Search Results Info -->
            <div
              *ngIf="termoBusca.trim().length > 0"
              class="flex items-center gap-1 flex-shrink-0"
            >
              <span
                *ngIf="totalResultados > 0"
                class="text-xs font-medium text-gray-500 whitespace-nowrap"
              >
                {{ indiceResultadoAtual + 1 }} de {{ totalResultados }}
              </span>
              <span
                *ngIf="totalResultados === 0"
                class="text-xs font-medium text-gray-400"
              >
                Nenhum resultado
              </span>
              <div class="flex items-center">
                <button
                  (click)="navigateToPreviousMatch()"
                  [disabled]="
                    totalResultados === 0 || indiceResultadoAtual <= 0
                  "
                  class="p-1 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <svg
                    class="w-4 h-4 transform rotate-180"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                </button>
                <button
                  (click)="navigateToNextMatch()"
                  [disabled]="
                    totalResultados === 0 ||
                    indiceResultadoAtual >= totalResultados - 1
                  "
                  class="p-1 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <svg
                    class="w-4 h-4"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                </button>
              </div>
              <button
                (click)="limparTermoBusca()"
                title="Limpar busca"
                class="p-1 rounded hover:bg-gray-100"
              >
                <svg
                  class="w-4 h-4 text-gray-500"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
              </button>
            </div>
          </div>
          <button
            (click)="desativarBusca()"
            title="Fechar busca"
            class="flex items-center justify-center w-9 h-9 rounded-lg hover:bg-gray-100 transition-colors flex-shrink-0"
          >
            <svg
              class="w-5 h-5 text-gray-600"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <!-- Transcription List -->
        <div #listaTranscricao class="transcription-list hide-scrollbar">
          <div
            *ngFor="let item of transcricaoExibida"
            class="transcription-item"
            (click)="irParaTimestamp(item.timestamp)"
            [ngClass]="{
              selected: isTimestampInSelection(item),
              playing: item.timestamp <= tempoAtualMs && tempoAtualMs < item.end,
              played: item.end <= tempoAtualMs
            }"
          >
            <div class="timestamp">
              {{ formatTimestamp(item.timestamp) }}
            </div>
            <p class="text-content" [innerHTML]="item.text"></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>